include ../common.mak

OBJS = usb_info.o disk_io_tools.o disk_initial.o disk_share.o
PROGS = libdisk.so write_smb_conf test_of_var_files
PROGS += test_disk1 test_disk2
PROGS += test_share
ifeq ($(RTCONFIG_WEBDAV),y)
PROGS += write_webdav_conf
endif

CFLAGS += -DASUS_NVRAM
CFLAGS += -I. -I$(TOP)/shared -I$(SRCBASE)/include -I$(LINUXDIR)/include -Wall
LDFLAGS = -L. -ldisk -L$(TOP)/nvram -lnvram -L$(TOP)/shared -lshared

CFLAGS += -I$(TOP)/busybox/include -I$(TOP)/busybox/util-linux/volume_id
OBJS += $(TOP)/busybox/util-linux/volume_id/util2.o
OBJS += $(TOP)/busybox/util-linux/volume_id/linux_swap.o
OBJS += $(TOP)/busybox/util-linux/volume_id/ext.o
OBJS += $(TOP)/busybox/util-linux/volume_id/fat.o
OBJS += $(TOP)/busybox/util-linux/volume_id/ntfs.o

#SHARE_STATIC=y

all: $(PROGS)

libdisk.so: $(OBJS) $(TOP)/shared/shutils.o
	$(LD) -shared -o $@ $^
	$(STRIP) $@

write_smb_conf: write_smb_conf.o libdisk.so
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
	$(STRIP) $@

ifeq ($(RTCONFIG_WEBDAV),y)
write_webdav_conf: write_webdav_conf.o libdisk.so
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
	$(STRIP) $@
endif

test_of_var_files: libdisk.so test_share
	ln -sf test_share test_of_var_files

test_disk1: test_disk1.o libdisk.so
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
	$(STRIP) $@

test_disk2: test_disk2.o
	$(CC) $(CFLAGS) -L$(TOP)/nvram -lnvram -L$(TOP)/shared -lshared -o $@ $^
	$(STRIP) $@

ifeq ($(SHARE_STATIC),y)
test_share: test_share.o disk_share.o
	@echo Got Static.
	$(CC) $(CFLAGS) $(LDFLAGS) -s -o $@ $^
else
test_share: test_share.o libdisk.so
	@echo Got lib.
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
endif
	$(STRIP) $@

install: all
	install -D test_disk1 $(INSTALLDIR)/sbin/test_disk1
	install -D test_disk2 $(INSTALLDIR)/sbin/test_disk2
	install -D test_share $(INSTALLDIR)/sbin/test_share

	install -D libdisk.so $(INSTALLDIR)/lib/libdisk.so
	install -D write_smb_conf $(INSTALLDIR)/sbin/write_smb_conf
ifeq ($(RTCONFIG_WEBDAV), y)
	install -D write_webdav_conf $(INSTALLDIR)/sbin/write_webdav_conf
endif
	cd $(INSTALLDIR)/sbin && ln -sf test_share test_of_var_files

	# test
	cd $(INSTALLDIR)/sbin && ln -sf test_share get_account_list
	cd $(INSTALLDIR)/sbin && ln -sf test_share get_folder_list
	cd $(INSTALLDIR)/sbin && ln -sf test_share get_all_folder
	cd $(INSTALLDIR)/sbin && ln -sf test_share get_var_file_name

	cd $(INSTALLDIR)/sbin && ln -sf test_share initial_folder_list
	cd $(INSTALLDIR)/sbin && ln -sf test_share initial_var_file
	cd $(INSTALLDIR)/sbin && ln -sf test_share initial_all_var_file
	cd $(INSTALLDIR)/sbin && ln -sf test_share test_of_var_files
	cd $(INSTALLDIR)/sbin && ln -sf test_share create_if_no_var_files
	cd $(INSTALLDIR)/sbin && ln -sf test_share modify_if_exist_new_folder

	cd $(INSTALLDIR)/sbin && ln -sf test_share get_permission
	cd $(INSTALLDIR)/sbin && ln -sf test_share set_permission

	cd $(INSTALLDIR)/sbin && ln -sf test_share add_account
	cd $(INSTALLDIR)/sbin && ln -sf test_share del_account
	cd $(INSTALLDIR)/sbin && ln -sf test_share mod_account
	cd $(INSTALLDIR)/sbin && ln -sf test_share test_if_exist_account

	cd $(INSTALLDIR)/sbin && ln -sf test_share add_folder
	cd $(INSTALLDIR)/sbin && ln -sf test_share del_folder
	cd $(INSTALLDIR)/sbin && ln -sf test_share mod_folder
	cd $(INSTALLDIR)/sbin && ln -sf test_share test_if_exist_share

	cd $(INSTALLDIR)/sbin && ln -sf test_share how_many_layer

clean:
	rm -f *.o $(PROGS)

